# OpenAIBundle 实用功能增强

## 核心问题

当前 OpenAIBundle 在生产环境中存在以下实际问题：
1. **单点故障**：一个 API Key 失效导致服务中断
2. **无健康监控**：无法预知 Key 何时失效
3. **缺乏统计**：不知道每个 Key 的使用量和成本

## 必要功能（仅实现真正需要的）

### 1. API Key 池化管理

#### 1.1 健康状态跟踪
在 `ApiKey` 实体添加最少必要字段：
```php
/**
 * @ORM\Column(type="datetime", nullable=true)
 */
private ?\DateTimeInterface $lastUsedAt = null;

/**
 * @ORM\Column(type="integer")
 */
private int $failureCount = 0;

/**
 * @ORM\Column(type="boolean")
 */
private bool $healthy = true;
```

#### 1.2 简单的 KeyPoolService
```php
class KeyPoolService
{
    public function getHealthyKey(string $model = null): ?ApiKey
    {
        // 1. 获取健康的 Key
        // 2. 按最后使用时间轮换
        // 3. 返回可用 Key 或 null
    }
    
    public function markKeyUnhealthy(ApiKey $key): void
    {
        $key->setHealthy(false);
        $key->incrementFailureCount();
    }
    
    public function resetKeyHealth(ApiKey $key): void
    {
        $key->setHealthy(true);
        $key->setFailureCount(0);
    }
}
```

### 2. 使用统计（成本控制）

#### 2.1 在 ApiKey 实体添加统计字段
```php
/**
 * @ORM\Column(type="bigint")
 */
private int $totalPromptTokens = 0;

/**
 * @ORM\Column(type="bigint")
 */
private int $totalCompletionTokens = 0;

/**
 * @ORM\Column(type="integer")
 */
private int $totalRequests = 0;
```

#### 2.2 自动更新统计
修改 `ConversationService`，在创建 Message 后更新 ApiKey 统计：
```php
public function createAssistantMessage(Message $message): void
{
    // 现有逻辑...
    
    // 更新 ApiKey 统计
    $apiKey = $message->getApiKey();
    if ($apiKey) {
        $apiKey->addTokenUsage(
            $message->getPromptTokens(),
            $message->getCompletionTokens()
        );
        $apiKey->incrementRequestCount();
    }
}
```

### 3. 批量健康检查

#### 3.1 命令行工具
```bash
# 检查所有 Key 的健康状态
php bin/console open-ai:key:health-check

# 重置失败的 Key
php bin/console open-ai:key:reset --failed
```

#### 3.2 实现逻辑
```php
class HealthCheckCommand extends Command
{
    protected function execute(InputInterface $input, OutputInterface $output): int
    {
        $keys = $this->apiKeyRepository->findAll();
        
        foreach ($keys as $key) {
            try {
                // 发送简单的测试请求
                $response = $this->openAiService->testConnection($key);
                $key->setHealthy(true);
                $output->writeln(sprintf('✓ %s', $key->getTitle()));
            } catch (\Exception $e) {
                $key->setHealthy(false);
                $output->writeln(sprintf('✗ %s: %s', $key->getTitle(), $e->getMessage()));
            }
        }
        
        $this->entityManager->flush();
        return Command::SUCCESS;
    }
}
```

### 4. 故障转移机制

修改 `OpenAiService` 支持自动故障转移：
```php
public function chat(array $messages, StreamRequestOptions $options): StreamResponseVO
{
    $maxRetries = 3;
    $lastException = null;
    
    for ($i = 0; $i < $maxRetries; $i++) {
        $apiKey = $this->keyPoolService->getHealthyKey($options->getModel());
        
        if (!$apiKey) {
            throw new \RuntimeException('没有可用的 API Key');
        }
        
        try {
            return $this->doChat($apiKey, $messages, $options);
        } catch (\Exception $e) {
            $this->keyPoolService->markKeyUnhealthy($apiKey);
            $lastException = $e;
        }
    }
    
    throw $lastException;
}
```

## 不需要的功能（YAGNI）

以下功能暂时**不实现**，因为没有实际需求：

1. ❌ **Provider 字段** - URL 已包含所有信息
2. ❌ **Model 实体** - 过度设计，配置文件足够
3. ❌ **复杂的映射规则** - 简单映射即可
4. ❌ **Admin 界面增强** - 命令行工具足够
5. ❌ **事件系统** - 直接调用更简单
6. ❌ **配置文件管理** - 数据库管理更灵活

## 实施计划

### 第一周：核心功能
- [ ] ApiKey 实体添加健康和统计字段
- [ ] 实现 KeyPoolService
- [ ] 修改 OpenAiService 支持故障转移
- [ ] 数据库迁移脚本

### 第二周：完善和测试
- [ ] 健康检查命令
- [ ] 统计更新逻辑
- [ ] 单元测试（>90% 覆盖率）
- [ ] 集成测试

## 数据库迁移

```sql
ALTER TABLE api_key ADD COLUMN last_used_at DATETIME DEFAULT NULL;
ALTER TABLE api_key ADD COLUMN failure_count INT DEFAULT 0;
ALTER TABLE api_key ADD COLUMN healthy BOOLEAN DEFAULT TRUE;
ALTER TABLE api_key ADD COLUMN total_prompt_tokens BIGINT DEFAULT 0;
ALTER TABLE api_key ADD COLUMN total_completion_tokens BIGINT DEFAULT 0;
ALTER TABLE api_key ADD COLUMN total_requests INT DEFAULT 0;
```

## 成功标准

1. **零宕机** - API Key 失效不影响服务
2. **可观测** - 随时了解 Key 的健康状态
3. **成本可控** - 清楚每个 Key 的使用成本
4. **简单可靠** - 代码量最少，复杂度最低

## 总结

这个精简版方案只解决**实际存在的问题**：
- 提高可用性（故障转移）
- 增加可观测性（健康监控）
- 控制成本（使用统计）

避免了原方案中的过度设计，遵循 KISS 和 YAGNI 原则，可以在 **2周内完成**并立即产生价值。

---

**文档版本**：1.0  
**创建日期**：2024-08-08  
**状态**：待实施